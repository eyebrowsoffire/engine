<!DOCTYPE html>
<html>
    <head>
        <title>Test Skwasm</title>
    </head>
    <body>
        <style>
            canvas {
                position: absolute;
                width: 400;
                height: 400;
            }
        </style>    
        <canvas id="test-canvas" width=400 height=400></canvas>
        <script>
            const script = document.createElement('script');
            script.src = "skwasm.js";
            document.body.appendChild(script);

            function stringFromDartString(string) {
                var length = inst.exports.$stringLength(string);
                var array = new Array(length);
                for (var i = 0; i < length; i++) {
                    array[i] = inst.exports.$stringRead(string, i);
                }
                return String.fromCharCode(...array);
            }

            function stringToDartString(string) {
                var length = string.length;
                var range = 0;
                for (var i = 0; i < length; i++) {
                    range |= string.codePointAt(i);
                }
                if (range < 256) {
                    var dartString = inst.exports.$stringAllocate1(length);
                    for (var i = 0; i < length; i++) {
                        inst.exports.$stringWrite1(dartString, i, string.codePointAt(i));
                    }
                    return dartString;
                } else {
                    var dartString = inst.exports.$stringAllocate2(length);
                    for (var i = 0; i < length; i++) {
                        inst.exports.$stringWrite2(dartString, i, string.codePointAt(i));
                    }
                    return dartString;
                }
            }

            // Imports for printing and event loop
            const dart2wasm = {
                printToConsole: function(string) {
                    console.log(stringFromDartString(string))
                },
                scheduleCallback: function(milliseconds, closure) {
                    setTimeout(function() {
                        inst.exports.$call0(closure);
                    }, milliseconds);
                },
                getCurrentStackTrace: function() {
                    // [Error] should be supported in most browsers.
                    // A possible future optimization we could do is to just save the
                    // `Error` object here, and stringify the stack trace when it is
                    // actually used.
                    let stackString = new Error().stack.toString();

                    // We remove the last three lines of the stack trace to prevent including
                    // `Error`, `getCurrentStackTrace`, and `StackTrace.current` in the
                    // stack trace.
                    let userStackString = stackString.split('\n').slice(3).join('\n');
                    return stringToDartString(userStackString);
                }
            };


            const dartTestModulePromise = WebAssembly.compileStreaming(fetch('skwasm_dart_test.wasm'));
            document.onreadystatechange = () => {
                if (document.readyState === "complete") {
                    (async () => {
                        const skwasmModule = (await skwasm()).asm;
                        const dartTestModule = await dartTestModulePromise;
                        const instance = await WebAssembly.instantiate(dartTestModule, {
                            "skwasm": skwasmModule,
                            "dart2wasm": dart2wasm,
                            "ffi": {"memory": skwasmModule.memory}
                        });
                        instance.exports.main();
                    })();
                }
            }
        </script>
    </body>
</html>
