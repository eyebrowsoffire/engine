<!DOCTYPE html>
<html>
    <head>
        <title>Skwasm Path Benchmark</title>
    </head>
    <body>
        <style>
            canvas {
                position: absolute;
                width: 400;
                height: 400;
            }
        </style>    
        <canvas id="test-canvas" width=400 height=400></canvas>
        <script src="skwasm.js"></script>
        <script src="dart_imports.js"></script>
        <script>
            var dartInstance;
            const dartTestModulePromise = WebAssembly.compileStreaming(fetch('skwasm_dart_bench.wasm'));
            document.onreadystatechange = () => {
                if (document.readyState === "complete") {
                    (async () => {
                        const skwasmModule = (await skwasm()).asm;
                        const dartTestModule = await dartTestModulePromise;
                        dartInstance = await WebAssembly.instantiate(dartTestModule, {
                            "skwasm": skwasmModule,
                            "dart2wasm": dart2wasm,
                            "ffi": {"memory": skwasmModule.memory}
                        });
                        dartInstance.exports.main();

                        let total = 0;
                        for(let i = 0; i < 300; i++) {
                            await (async () => {
                                return new Promise((resolve) => {
                                    setTimeout(() => {
                                        const start = performance.now()
                                        const time = dartInstance.exports.benchPaths();
                                        const elapsed = performance.now() - start;
                                        total += elapsed;
                                        console.log(`Bench [${i}] took ${elapsed} milliseconds`);
                                        resolve();
                                    })
                                })
                            })();
                        }

                        console.log(`Average time: ${total / 300} milliseconds`);
                    })();
                }
            }
        </script>
    </body>
</html>
